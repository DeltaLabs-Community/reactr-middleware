import{v as w}from"./chunk-NL6KNZEE-njEFggvy.js";class m{static async executeMiddlewares(e,t,i=!1,n=!1,o){let a={continue:!0,data:{},headers:{}},u={},s={};if(i&&!h(e)&&f(e))return this.executeMiddlewaresParallel(e,t,n,o);if(h(e)&&!f(e))for(const d of e){if(typeof d=="object"&&("parallel"in d||"sequential"in d)?a=await this.executeRegistryMiddleware(d,t,n,o):a=await this.executeMiddlewares([d],t,i,n,o),!a.continue){if(n)throw new Error("Middleware failed");return{continue:!1,data:a.data,headers:a.headers,redirect:a.redirect||o}}a.data&&(u={...u,...a.data},t.data={...t.data,...a.data}),a.headers&&(s={...s,...a.headers})}else if(f(e))for(const d of e){if(a=await d(t),!a.continue){if(n)throw new Error("Middleware failed");return{continue:!1,data:a.data,headers:a.headers,redirect:a.redirect||o}}a.data&&(u={...u,...a.data},t.data={...t.data,...a.data}),a.headers&&(s={...s,...a.headers})}return{continue:!0,data:u,headers:s}}static async executeRegistryMiddleware(e,t,i=!1,n){let o={continue:!0,data:{},headers:{}},a={},u={};for(const s in e){if(s==="parallel"?o=await this.executeMiddlewaresParallel(e[s],t,i,n):s==="sequential"&&(o=await this.executeMiddlewares(e[s],t,!1,i,n)),!o.continue)return o;o.data&&(a={...a,...o.data},t.data={...t.data,...o.data}),o.headers&&(u={...u,...o.headers})}return{continue:!0,data:a,headers:u}}static async executeMiddlewaresParallel(e,t,i=!1,n){const o=await Promise.all(e.map(async s=>{const d=await s(t);if(!d.continue){if(i)throw new Error("Middleware failed");return{continue:!1,data:d.data,headers:d.headers,redirect:d.redirect||n}}return d}));let a={},u={};for(const s of o){if(!s.continue)return{continue:!1,data:s.data,headers:s.headers,redirect:s.redirect||n};s.data&&(a={...a,...s.data},t.data={...t.data,...s.data}),s.headers&&(u={...u,...s.headers})}return{continue:!0,data:a,headers:u,redirect:n}}static createReactRouterLoader(e,t=!1,i=!1,n){return async({request:o,params:a})=>{try{const u=new URL(o.url),s={request:o,params:a,searchParams:u.searchParams,pathname:u.pathname},d=await this.executeMiddlewares(e,s,t,i,n);return d.redirect?w(d.redirect):{middlewareData:d.data||{},headers:d.headers||{}}}catch(u){if(n)return w(n);throw console.error(u),new Error("Middleware failed")}}}}const l={requireAuth:(r="/login")=>async e=>{const t=e.request.headers.get("Authorization");return t&&t.startsWith("Bearer ")?{continue:!0}:{redirect:r,continue:!1}},cors:(r={})=>async e=>{const{origins:t=["*"],methods:i=["GET","POST","PUT","DELETE"]}=r;return{continue:!0,headers:{"Access-Control-Allow-Origin":t.join(", "),"Access-Control-Allow-Methods":i.join(", "),"Access-Control-Allow-Headers":"Content-Type, Authorization"}}},rateLimit:(r=100,e=6e4)=>{const t=new Map;return async i=>{const n=i.request.headers.get("x-forwarded-for")||"unknown",o=Date.now(),a=t.get(n)||{count:0,resetTime:o+e};return o>a.resetTime&&(a.count=0,a.resetTime=o+e),a.count++,t.set(n,a),a.count>r?{continue:!1,headers:{"X-RateLimit-Limit":r.toString(),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":a.resetTime.toString()}}:{continue:!0,headers:{"X-RateLimit-Limit":r.toString(),"X-RateLimit-Remaining":(r-a.count).toString(),"X-RateLimit-Reset":a.resetTime.toString()}}}},logger:(r={})=>async e=>{const t=Date.now();if(console.log(`[${new Date().toISOString()}] ${e.request.method} ${e.pathname}`),r.includeBody&&e.request.method!=="GET")try{const n=await e.request.clone().text();console.log("Request body:",n)}catch{console.log("Could not parse request body")}const i=Date.now()-t;return console.log(`Request processed in ${i}ms`),{continue:!0}}};function h(r){return Array.isArray(r)&&r.length>0&&r.every(e=>typeof e=="function"||typeof e=="object"&&("parallel"in e||"sequential"in e))}function f(r){return Array.isArray(r)&&r.length>0&&r.every(e=>typeof e=="function")}const p=class p{static register(e,t){this.middlewareGroups.set(e,t)}static get(e){const t=this.middlewareGroups.get(e);if(!t)throw new Error(`Middleware group "${e}" not found. Available groups: ${Array.from(this.middlewareGroups.keys()).join(", ")}`);return t}static createLoaderFromGroup(e){const t=e.map(i=>this.get(i));if(t.every(i=>h(i)))throw new Error("Cannot combine multiple GroupMiddlewareConfig");if(t.some(i=>!Array.isArray(i)))throw new Error("Cannot combine Middleware[] with GroupMiddlewareConfig");return[].concat(t[0])}static createLoader(e,t=!1,i=!1,n){return Array.isArray(e)?m.createReactRouterLoader(this.createLoaderFromGroup(e),t,i,n):m.createReactRouterLoader(this.get(e),t,i,n)}static list(){return Array.from(this.middlewareGroups.keys())}};p.middlewareGroups=new Map;let g=p;function c(r,e){g.register(r,e)}var y=(r=>(r.Public="public",r.Protected="protected",r.Admin="admin",r.Api="api",r.ProfilePage="profilePage",r.ProductPage="productPage",r))(y||{});c("public",[l.logger({includeBody:!1}),l.cors()]);c("protected",[l.logger({includeBody:!0}),l.requireAuth("/login"),l.rateLimit(50,6e4)]);c("admin",[l.logger({includeBody:!0}),l.requireAuth("/login"),l.rateLimit(20,6e4)]);c("api",[l.cors({origins:["http://localhost:3000","https://yourdomain.com"],methods:["GET","POST","PUT","DELETE"]}),l.rateLimit(100,6e4),l.logger({includeBody:!0})]);c("profilePage",[l.logger({includeBody:!0}),r=>(console.log("running profilePage middleware"),{continue:!0,data:{profilePage:"profilePage"}})]);c("productPage",[function(r){return console.log("running productPage1 middleware sequential"),{continue:!0,data:{productPage:"productPage"}}},{parallel:[function(r){return console.log("running productPage2 middleware1 parallel"),{continue:!0,data:r.data}},function(r){const e={...r.data,productPageParallel:"productPageParallel"};return console.log("running productPage3 middleware2 parallel"),{continue:!0,data:e}}],sequential:[function(r){const e={...r.data,productPageSequential:"productPageSequential"};return console.log("running productPage4 middleware sequential"),{continue:!0,data:e}}]}]);export{y as MiddlewareGroup};
